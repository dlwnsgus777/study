
## 컬렉션과 부가 기능

---

### 컬렉션

JPA는 자바에서 기본으로 제공하는 `Collection`, `List`, `Set`, `Map` 컬렉션을 지원한다.

- `@OneToMany`, `@ManyToMany`를 사용해 일대다나 다대다 엔티티 관계를 매핑할 떄
- `@ElementCollection`을 사용해서 값 타입을 하나 이상 보관할 때

자바 컬렉션 인터페이스의 특징은 다음과 같다.

- `Collection`: 자바가 제공하는 최상위 컬렉션. 
  - 하이버네이트는 중복을 허용하고 순서를 보장하지 않는다고 가정한다.
- `Set`: 중복을 허용하지 않는 컬렉션. 순서를 보장하지 않는다.
- `List`: 순서가 있는 컬렉션. 순설르 보장하고 중복을 허용한다.
- `Map`: key, value 구조로 되어 있는 특수한 컬렉션

JPA 명세에는 자바 컬렉션 인터페이스에 대한 특별한 언급이 없으므로 하이버네이트 구현제를 기준으로 설명한다.

### JPA와 컬렉션

하이버네이트는 엔티티를 영속 상태로 만들 때 컬렉션 필드를 하이버네이트에서 준비한 컬렉션으로 감싸서 사용한다.

하이버네이트는 컬렉션을 효율적으로 관리하기 위해 엔티티를 영속 상태로 만들 때 원본 컬렉션을 감싸고 있는 내장 컬렉션을 생성해 내장 컬렉션을 사용하도록 참조를 변경한다.

이를 **래퍼 컬렉션**으로도 부른다.

이런 특징 때문에 하이버네이트는 컬렉션을 사용할 때 즉시 초기화해 사용하는 것을 권장한다.

```java
Collection<Member> members = new ArrayList<Member>();
```

- `Collection`, `List`
  - 내장 컬렉션 : `PersistenBag`
  - 중복 허용, 순서 보장 안함
- `Set`
  - 내장 컬렉션 : `PersistenSet`
  - 중복 허용 안함, 순서 보장 안함
- `List` + `@OrderColunm`
  - 내장 컬렉션 : `PersistenList`
  - 중복 허용, 순서 보장

### Collection, List

`Collection`, `List` 인터페이스는 중복을 허용하는 컬렉션이다.

`PersistenBag`을 래퍼 컬렉션으로 사용한다.

이 인터페이스는 `ArrayList`로 초기화하면 된다.

중복을 허용한다고 가정하므로 `add()` 메서드는 내부에서 어떤 비교도 하지 않고 항상 `true`를 반환한다.

같은 엔티티가 있는지 찾거나 삭제할 때는 `equals()` 메서드를 사용한다.

**엔티티를 추가할 때 중복된 엔티티가 있는지 비교하지 않고 단순히 저장만 하기 때문에 엔티티를 추가해도 지연 로딩된 컬렉션을 초기화하지 않는다.**

### Set

`Set`은 중복을 허용하지 않는 컬렉션이다. 

`PersistenSet`을 컬렉션 래퍼로 사용한다.

이 인터페이스는 `HashSet`으로 초기화하면 된다.

중복을 허용하지 않으므로 `add()` 메서드는 객체를 추가할 때마다 `equals()` 메서드로 같은 객체가 있는지 비교한다.

같은 객체가 없으면 객체를 추가하고 `true`를 반환하고, 같은 객체가 있으면 추가에 실패하고 `false`를 반환한다.

`HashSet`은 해시 알고리즘을 사용하므로 `hashcode()`도 함께 사용해서 비교한다.

**엔티티를 추가할 때 중복된 엔티티가 있는지 비교하기 때문에 엔티티를 추가할 때 지연 로딩된 컬렉션을 초기화한다.**

### List + @OderColumn

List 인터페이스에 `@OderColumn`을 추가하면 순서가 있는 특수한 컬렉션으로 인식한다.

데이터베이스에 순서 값을 저장해서 조회할 때 사용한다.

`PersistenList`를 컬렉션 래퍼로 사용한다.

```java
@OneToMany(mappedBy = "board")
@OrderColumn(name = "POSITION")
private List<Comment> comments = new ArrayList<Comment>();
```
순서가 있는 컬렉션은 데이터베이스에 순서 값도 함께 관리한다.

